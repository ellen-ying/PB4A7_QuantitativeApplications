---
title: "20221215_main_analysis"
author: "Yurun (Ellen) Ying"
date: "2022-12-15"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse);library(haven);library(here);library(broom);library(wesanderson);library(rdrobust)

# input data
bac_data <- 
  here("summative/data/hansen_dwi.dta") %>% 
  read_dta() %>% 
  mutate(
    # code into drive under influence (dui) = 1 if bac1 >= 0.08
    dui = ifelse(bac1 >= 0.08, 1, 0),
    
    # create a centered bac1 variable
    bac1_ctd = bac1 - 0.08,
    
    # create a quadratic term from bac1
    bac1_sq = bac1^2,
    
    # create donut hole for later use
    donut = ifelse(abs(bac1_ctd) <= 0.001, 1, 0)
    )

source(here("summative/code/summaryR.R"))
```

## Main analysis

Run the main analysis of the effect of treatment (punishment) on recidivism.

```{r}
# analysis officially given in the do file
# get the data within the 0.05 bandwidth
dat_bandwidth_0.05 <- bac_data %>% filter(abs(bac1_ctd) <= 0.05)

# linear regression
linear_a <- 
  dat_bandwidth_0.05 %>% 
  lm(recidivism ~ dui*bac1 + white + male + acc + aged,
     data = .)
summaryR.lm(linear_a, type = "hc1")

# quadratic model
qua_a <- 
  dat_bandwidth_0.05 %>% 
  lm(recidivism ~ dui*(bac1 + bac1_sq) + white + male + acc + aged,
     data = .)
summaryR.lm(qua_a, type = "hc1")


# get the data within the 0.025 bandwidth
dat_bandwidth_0.025 <- bac_data %>% filter(abs(bac1_ctd) <= 0.025)

# linear regression
linear_b <- 
  dat_bandwidth_0.025 %>% 
  lm(recidivism ~ dui*bac1 + white + male + acc + aged,
     data = .)
summaryR.lm(linear_b, type = "hc1")

# quadratic model
qua_b <- 
  dat_bandwidth_0.025 %>% 
  lm(recidivism ~ dui*(bac1 + bac1_sq) + white + male + acc + aged,
     data = .)
summaryR.lm(qua_b, type = "hc1")
```

The linear model estimates indicate that receiving punishment decreased the rate of recidivism by 5.91 percentage point (6.4 percentage when using 0.025 bandwidth). The quadratic model estimates indicate that receiving punishment decreased the rate of recidivism by 11.3 percentage point (37.1 percentage when using 0.025 bandwidth).

Make the scatter plots

```{r}
#min_bac <- min(dat_bandwidth_0.05$bac1) 
min_bac <- .030999999
max_bac_lower <- filter(dat_bandwidth_0.05, bac1_ctd < 0)$bac1 %>% max()
max_bac <- max(dat_bandwidth_0.05$bac1)
breaks <- c(seq(min_bac, max_bac_lower, length.out = 43), 
               seq(0.08, max_bac, length.out = 49)[-1])


dat_bandwidth_0.05 %>% 
  # create 90 bins with one break at the cutoff point
  mutate(bins = cut(bac1, breaks = breaks)) %>% 
   # select(bins, bac1) %>% arrange(bac1) %>% View()
  group_by(bins) %>% 
  summarize(
    recidivism = mean(recidivism), # calculate the mean recidivism in each group
    bac = mean(bac1), # roughly the midpoint of each bin
    dui = ifelse(bac >=0.08, 1, 0) %>% factor()
  ) %>% 
  ggplot(aes(x = bac, y = recidivism, color = dui)) +
  geom_point(show.legend = FALSE) +
  geom_vline(xintercept = 0.08, color = "red", linetype = 2) +
  scale_x_continuous(breaks = seq(0.02, 0.14, by = 0.02)) +
  scale_y_continuous(breaks = seq(0.07, 0.15, by = 0.02)) +
  scale_color_discrete(type = wes_palette("Royal1", 2, type = "discrete")) +
  labs(x = "Blood Alcohol Content (BAC)", y = "Recidivism") +
  theme_classic() +
  theme(
    panel.grid = element_blank(),
    panel.grid.major.y = element_line(color = "grey80", size = 0.4),
    axis.line = element_line(size = 0.4),
    axis.text.y = element_text(size = 11, margin = margin(0, 5, 0, 0)),
    axis.text.x = element_text(size = 11, margin = margin(5, 0, 0, 0)),
    axis.ticks = element_line(size = 0.4),
    axis.ticks.length = unit(6, units = "pt"),
    axis.title.y = element_text(size = 13, margin = margin(0, 10, 0, 0)),
    axis.title.x = element_text(size = 13, margin = margin(10, 0, 0, 0)),
    plot.margin = margin(20, 20, 20, 20)
  )
         
```


## Donut hole regression

Since there is heaping in our data, we will run a donut hole regression and check the robustness of our results.

```{r}
# add donut hole
dat_bandwidth_0.05 <- 
  # observation are dropped within one unit next to the cutoff point
  dat_bandwidth_0.05 %>% mutate(donut = ifelse(abs(bac1_ctd) <= 0.001, 1, 0))

# linear regression
linear_a_donut <- 
  dat_bandwidth_0.05 %>% 
  filter(donut == 0) %>% 
  lm(recidivism ~ dui*bac1 + white + male + acc + aged,
     data = .)
summaryR.lm(linear_a_donut, type = "hc1")

# narrower bandwidth
dat_bandwidth_0.025 <- 
  dat_bandwidth_0.025 %>% mutate(donut = ifelse(abs(bac1_ctd) <= 0.001, 1, 0))

# linear regression
linear_b_donut <- 
  dat_bandwidth_0.025 %>% 
  filter(donut == 0) %>% 
  lm(recidivism ~ dui*bac1 + white + male + acc + aged,
     data = .)
summaryR.lm(linear_b_donut, type = "hc1")
```

The donut hole regressions indicate that receiving punishment decreased the rate of recidivism by 5.57 percentage point (and 5.62 pp using 0.025 bandwidth).


Use the package `rdrobust` to run the local polynomial regressions with kernel function and bias correction with a donut hole.

```{r}
# local polynomial with all data around the cutoff point
linear_a_robust <- 
  with(bac_data,
       rdrobust(recidivism, bac1, # outcome and predictor
                c = 0.08, # cutoff point
                p = 2, # second-order polynomial
                kernel = "epanechnikov", # kernel function
                masspoints = FALSE
                ))
summary(linear_a_robust)

# local polynomial after the donut hole
linear_a_donut_robust <- 
  with(filter(bac_data, donut == 0),
       rdrobust(recidivism, bac1, # outcome and predictor
                c = 0.08, # cutoff point
                p = 2, # second-order polynomial
                kernel = "uniform", # kernel function
                masspoints = FALSE
                ))
summary(linear_a_donut_robust)
```

Attempt to answer why local polynomials are needed in a donut hole regression when analyzing data with heaping:

- We are unable to estimate the local average treatment effect after dropping observations near the cutoff point; rather, we can only use regressions to extrapolate from the undropped observations to the donut region. **Therefore, the assumed shape of the relation between running variable and the outcome can influence our estimates more than it does in regression discontinuity design without a donut hole.** Running both the linear regression and the polynomial regression can help us check the robustness of our result.

The sentence in bold needs some simulation support.


Create the regression discotinuity plot.

```{r}
with(dat_bandwidth_0.05,
     rdplot(recidivism, bac1,
            c = 0.08, # cutoff point
            p = 4, # order of the polynomial
            # binselect = "qs", # method for select number of bins
            masspoints = FALSE,
            x.label = "Blood Alcohol Content (BAC)",
            y.label = "Recidivism"))
```



## Notes for improvement

- Mindful of the kernel function choice in local polynomial regression
- Consider what controls to put in the model and how they should be put
- Be mindful of the interpretation of uncentered running variable; or center the variable and rerun the analyses
